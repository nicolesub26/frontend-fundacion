<form class="space-y-6" [formGroup]="form" (ngSubmit)="guardar()" >

  <!-- Header -->
  <div class="rounded-2xl p-6 text-white bg-gradient-to-r from-sky-500 to-blue-600 shadow">
    <h1 class="text-2xl font-semibold">Registrar gasto (Fundaci√≥n)</h1>
    <p class="text-white/90">Cabecera + l√≠neas de detalle por art√≠culo</p>
  </div>

  <!-- Cabecera -->
  <div class="rounded-2xl bg-white p-5 shadow border border-gray-100 space-y-4">
    <div class="grid md:grid-cols-5 gap-4">
      <div>
        <label class="text-sm font-medium text-gray-700">Fecha</label>
        <input type="date" class="w-full rounded-xl border border-gray-200 px-3 py-2"
               formControlName="fechaGasto" />
      </div>

      <div class="md:col-span-2">
        <label class="text-sm font-medium text-gray-700">Tipo de gasto</label>
        <select class="w-full rounded-xl border border-gray-200 px-3 py-2 bg-white"
                formControlName="tipoGastoId">
          <option [ngValue]="null" disabled>Selecciona‚Ä¶</option>
          <option *ngFor="let t of tiposGasto()" [ngValue]="t.idTipoGasto">{{ t.descripcion }}</option>
        </select>
      </div>

      <div class="md:col-span-2">
        <label class="text-sm font-medium text-gray-700">Empleado</label>
        <select class="w-full rounded-xl border border-gray-200 px-3 py-2 bg-white"
                formControlName="empleadoId">
          <option [ngValue]="null" disabled>Selecciona‚Ä¶</option>
          <option *ngFor="let e of empleados()" [ngValue]="e.id">{{ e.nombre }} {{ e.apellido }}</option>
        </select>
      </div>
    </div>

    <div class="grid md:grid-cols-3 gap-4">
      <div class="md:col-span-2">
        <label class="text-sm font-medium text-gray-700">Descripci√≥n</label>
        <input class="w-full rounded-xl border border-gray-200 px-3 py-2"
               formControlName="descripcion" placeholder="Motivo del gasto" />
      </div>
      <div>
        <label class="text-sm font-medium text-gray-700">Comprobante</label>
        <input class="w-full rounded-xl border border-gray-200 px-3 py-2"
               formControlName="comprobante" placeholder="Factura / recibo" />
      </div>
    </div>
  </div>

  <!-- Detalle -->
  <div class="rounded-2xl bg-white shadow border border-gray-100 overflow-hidden">
    <div class="px-5 py-4 flex items-center justify-between bg-gray-50">
      <h2 class="font-semibold text-gray-800">L√≠neas de detalle</h2>
      <button type="button" (click)="addDetalle()"
              class="rounded-xl bg-sky-600 text-white px-4 py-2 font-medium shadow hover:bg-sky-700">
        Agregar l√≠nea
      </button>
    </div>

    <div class="overflow-x-auto">
      <table class="min-w-full divide-y divide-gray-200">
        <thead class="bg-gray-50">
          <tr class="text-left text-xs font-semibold text-gray-600">
            <th class="px-4 py-3">Art√≠culo</th>
            <th class="px-4 py-3">Descripci√≥n</th>
            <th class="px-4 py-3">Cant.</th>
            <th class="px-4 py-3">Precio Unit.</th>
            <th class="px-4 py-3">Unidad</th>
            <th class="px-4 py-3">Proveedor</th>
            <th class="px-4 py-3 text-right">Subtotal</th>
            <th class="px-4 py-3 text-center">Acciones</th>
          </tr>
        </thead>

        <tbody class="divide-y divide-gray-100 text-sm">
          <!-- üëá El formArray debe ser hijo del form -->
          <ng-container formArrayName="detalles">
            <tr *ngFor="let g of detalles.controls; let i = index" [formGroupName]="i">
              <td class="px-4 py-3 min-w-[240px]">
                <select class="w-full rounded-lg border border-gray-200 px-3 py-2 bg-white"
                        formControlName="articuloId">
                  <option [ngValue]="null" disabled>Selecciona‚Ä¶</option>
                  <option *ngFor="let a of articulos()" [ngValue]="a.idArticulo">
                    {{ a.nombreArticulo }} ‚Äî {{ a.categoria?.nombreCategoria || 'Sin categor√≠a' }}
                  </option>
                </select>
              </td>

              <td class="px-4 py-3">
                <input class="w-full rounded-lg border border-gray-200 px-3 py-2"
                       formControlName="descripcion" placeholder="Detalle" />
              </td>

              <td class="px-4 py-3 w-24">
                <input type="number" min="1" step="1"
                       class="w-full rounded-lg border border-gray-200 px-3 py-2 text-right"
                       formControlName="cantidad" />
              </td>

              <td class="px-4 py-3 w-36">
                <input type="number" min="0.01" step="0.01"
                       class="w-full rounded-lg border border-gray-200 px-3 py-2 text-right"
                       formControlName="precio" />
              </td>

              <td class="px-4 py-3 w-28">
                <input class="w-full rounded-lg border border-gray-200 px-3 py-2"
                       formControlName="unidad" placeholder="un, caja, par‚Ä¶" />
              </td>

              <td class="px-4 py-3 w-40">
                <input class="w-full rounded-lg border border-gray-200 px-3 py-2"
                       formControlName="proveedor" placeholder="Proveedor" />
              </td>

              <td class="px-4 py-3 w-32 text-right font-medium">
                {{ filaSubtotal(i) | number:'1.2-2' }}
              </td>

              <td class="px-4 py-3">
                <div class="flex items-center justify-center">
                  <button type="button" (click)="removeDetalle(i)"
                          class="p-2 rounded-lg bg-rose-100 hover:bg-rose-200" title="Eliminar">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 24 24" fill="currentColor">
                      <path d="M9 3h6l1 2h5v2H3V5h5l1-2zm1 6h2v9h-2V9zm4 0h2v9h-2V9z"/>
                    </svg>
                  </button>
                </div>
              </td>
            </tr>
          </ng-container>
        </tbody>
      </table>
    </div>

    <!-- Totales -->
    <div class="px-5 py-4 bg-gray-50">
      <div class="flex flex-col md:flex-row md:justify-end gap-3">
        <div class="grid grid-cols-2 gap-2 text-sm md:min-w-[360px]">
          <div class="text-right text-gray-600">Subtotal</div>
          <div class="text-right font-medium">{{ totales().subtotal | number:'1.2-2' }}</div>
          <div class="text-right text-gray-800">Total</div>
          <div class="text-right font-semibold">{{ totales().total | number:'1.2-2' }}</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Acciones -->
  <div class="flex items-center justify-end gap-2">
    <button type="button" (click)="limpiar()"
            class="rounded-xl bg-gray-100 text-gray-700 px-4 py-2 font-medium hover:bg-gray-200">
      Limpiar
    </button>
    <button type="submit"[disabled]="loading() || form.invalid || detalles.length===0">Guardar</button>

  </div>

</form>
